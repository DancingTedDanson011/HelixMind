name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          command_timeout: 10m
          script: |
            set -e
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

            echo "=== Git Fetch & Reset ==="
            cd /opt/helixmind/web
            git fetch origin main
            git reset --hard origin/main

            echo "=== Stop PM2 (all) ==="
            pm2 stop all 2>/dev/null || true

            echo "=== Enter web directory ==="
            cd /opt/helixmind/web/web

            # Copy .env from parent if not present
            if [ ! -f .env ] && [ -f /opt/helixmind/web/.env ]; then
              cp /opt/helixmind/web/.env .env
              echo "Copied .env from repo root"
            fi

            set -a && source .env && set +a

            echo "=== Clean node_modules ==="
            if [ -d node_modules ]; then
              find node_modules -type f -delete 2>/dev/null || true
              find node_modules -type d -empty -delete 2>/dev/null || true
              rm -rf node_modules 2>/dev/null || true
            fi
            rm -rf node_modules_old_* 2>/dev/null || true

            echo "=== NPM Install ==="
            npm ci --include=dev

            echo "=== Prisma DB Push ==="
            npx prisma db push --accept-data-loss

            echo "=== Prisma Generate ==="
            npx prisma generate

            echo "=== Build ==="
            npm run build

            echo "=== PM2 Restart ==="
            pm2 delete helixmind-web 2>/dev/null || true
            pm2 start ecosystem.config.cjs
            pm2 start helixmind-webhook 2>/dev/null || true
            sleep 3

            echo "=== PM2 Status ==="
            pm2 status

            echo "=== PM2 Logs (last 30 lines) ==="
            pm2 logs helixmind-web --nostream --lines 30 || true

            pm2 save
            echo "=== Deploy complete: $(date) ==="
