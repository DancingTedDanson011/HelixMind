<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HelixMind Brain</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{overflow:hidden;background:#050510;font-family:'JetBrains Mono',monospace;color:#ccc;user-select:none}
canvas{display:block;width:100vw;height:100vh}

/* ─── HUD ─── */
#hud{position:fixed;inset:0;pointer-events:none;z-index:10}
.hud-panel{position:absolute;pointer-events:auto}

/* Top-left — Identity */
#identity{top:20px;left:24px;font-size:11px;line-height:1.6;opacity:.7}
#identity .title{font-size:14px;font-weight:500;color:#00d4ff;letter-spacing:1px;display:flex;align-items:center;gap:8px}
#identity .title .dot{width:6px;height:6px;border-radius:50%;background:#00ff88;animation:pulse-dot 2s ease infinite}
#identity .stats{color:#556;margin-top:2px}
@keyframes pulse-dot{0%,100%{opacity:.4;transform:scale(.8)}50%{opacity:1;transform:scale(1.2)}}

/* Top-right — Controls */
#controls{top:20px;right:24px;display:flex;flex-direction:column;gap:6px}
.control-group{background:rgba(5,5,16,.85);border:1px solid rgba(0,212,255,.1);border-radius:8px;padding:8px 12px;backdrop-filter:blur(12px)}
.control-group label{font-size:10px;color:#556;display:block;margin-bottom:4px;text-transform:uppercase;letter-spacing:1px}

.toggle-btn{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;margin:1px;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.08);border-radius:4px;color:#334;cursor:pointer;font-size:10px;transition:all .3s;user-select:none;opacity:.35}
.toggle-btn .ldot{width:6px;height:6px;border-radius:50%;flex-shrink:0;transition:all .3s;filter:saturate(.2) brightness(.4)}
.toggle-btn .lcount{font-size:9px;opacity:.5;margin-left:2px}
.toggle-btn.active{opacity:1}
.toggle-btn.active .ldot{filter:saturate(1) brightness(1)}
.toggle-btn:hover{opacity:.8}
.toggle-btn[data-edge]{opacity:.4}
.toggle-btn[data-edge].active{opacity:1;background:rgba(0,212,255,.12);border-color:rgba(0,212,255,.3);color:#00d4ff}

/* Bottom-left — Detail Panel */
#detail{bottom:24px;left:24px;background:rgba(5,5,16,.85);border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:16px 20px;max-width:320px;font-size:11px;line-height:1.7;backdrop-filter:blur(12px);opacity:0;transform:translateY(10px);transition:opacity .4s,transform .4s;pointer-events:none}
#detail.visible{opacity:1;transform:translateY(0);pointer-events:auto}
#detail .detail-label{font-size:14px;font-weight:500;color:#fff;margin-bottom:6px}
#detail .detail-meta{color:#667;display:flex;flex-wrap:wrap;gap:4px 12px}
#detail .detail-meta span{display:flex;align-items:center;gap:4px}
#detail .detail-conn{margin-top:8px;color:#556}
#detail .detail-close{position:absolute;top:8px;right:12px;cursor:pointer;color:#445;font-size:16px}
#detail .detail-close:hover{color:#fff}

/* Bottom-center — Search */
#search-wrap{bottom:24px;left:50%;transform:translateX(-50%);pointer-events:auto}
#search{background:rgba(5,5,16,.7);border:1px solid rgba(255,255,255,.08);border-radius:20px;padding:8px 20px;width:260px;font-family:inherit;font-size:11px;color:#ccc;outline:none;backdrop-filter:blur(10px);transition:border-color .3s,width .3s}
#search:focus{border-color:rgba(0,212,255,.3);width:320px}
#search::placeholder{color:#334}

/* Bottom-right — Legend */
#legend{bottom:56px;left:24px;background:rgba(5,5,16,.85);border:1px solid rgba(0,212,255,.1);border-radius:8px;padding:10px 14px;backdrop-filter:blur(12px);font-size:10px;color:#556}
#legend .item{display:flex;align-items:center;gap:6px;margin:2px 0}
#legend .dot{width:8px;height:8px;border-radius:50%;box-shadow:0 0 6px currentColor}

/* Status bar */
#status{bottom:16px;right:24px;font-size:10px;color:#445;background:rgba(5,5,16,.7);border:1px solid rgba(0,212,255,.08);border-radius:8px;padding:6px 14px;backdrop-filter:blur(8px)}

/* Tooltip */
#tooltip{position:fixed;display:none;z-index:25;background:rgba(5,5,16,.97);border:1px solid rgba(0,212,255,.25);border-radius:10px;padding:12px 16px;pointer-events:none;backdrop-filter:blur(16px);max-width:320px;box-shadow:0 8px 32px rgba(0,0,0,.5),0 0 16px rgba(0,212,255,.08)}
#tooltip .tt-label{color:#00d4ff;font-size:13px;font-weight:600}
#tooltip .tt-meta{color:#556;font-size:10px;margin-top:2px}
</style>
</head>
<body>

<!-- HUD -->
<div id="hud">
  <div id="identity" class="hud-panel">
    <div class="title"><span class="dot"></span> HelixMind Brain</div>
    <div class="stats" id="stats"></div>
  </div>

  <div id="controls" class="hud-panel">
    <div class="control-group">
      <label>Levels</label>
      <span class="toggle-btn active" data-level="5" data-color="#6c757d"><span class="ldot" style="background:#6c757d;box-shadow:0 0 6px #6c757d"></span>L5 Deep<span class="lcount" id="lc5"></span></span>
      <span class="toggle-btn active" data-level="4" data-color="#8a2be2"><span class="ldot" style="background:#8a2be2;box-shadow:0 0 6px #8a2be2"></span>L4 Archive<span class="lcount" id="lc4"></span></span>
      <span class="toggle-btn active" data-level="3" data-color="#4169e1"><span class="ldot" style="background:#4169e1;box-shadow:0 0 6px #4169e1"></span>L3 Ref<span class="lcount" id="lc3"></span></span>
      <span class="toggle-btn active" data-level="2" data-color="#00ff88"><span class="ldot" style="background:#00ff88;box-shadow:0 0 6px #00ff88"></span>L2 Active<span class="lcount" id="lc2"></span></span>
      <span class="toggle-btn active" data-level="1" data-color="#00ffff"><span class="ldot" style="background:#00ffff;box-shadow:0 0 6px #00ffff"></span>L1 Focus<span class="lcount" id="lc1"></span></span>
      <span class="toggle-btn active" data-level="6" data-color="#ffaa00"><span class="ldot" style="background:#ffaa00;box-shadow:0 0 6px #ffaa00"></span>L6 Web<span class="lcount" id="lc6"></span></span>
    </div>
    <div class="control-group">
      <label>Relations</label>
      <span class="toggle-btn active" data-edge="all">All</span>
      <span class="toggle-btn" data-edge="references">Refs</span>
      <span class="toggle-btn" data-edge="depends_on">Depends</span>
      <span class="toggle-btn" data-edge="related_to">Related</span>
      <span class="toggle-btn" data-edge="evolved_from">Evolved</span>
      <span class="toggle-btn" data-edge="supports">Supports</span>
      <span class="toggle-btn" data-edge="extends">Extends</span>
      <span class="toggle-btn" data-edge="implements">Impl</span>
      <span class="toggle-btn" data-edge="uses">Uses</span>
      <span class="toggle-btn" data-edge="imports">Imports</span>
    </div>
  </div>

  <div id="detail" class="hud-panel">
    <div class="detail-close" id="detail-close">&times;</div>
    <div class="detail-label" id="detail-label"></div>
    <div class="detail-meta" id="detail-meta"></div>
    <div class="detail-conn" id="detail-conn"></div>
  </div>

  <div id="search-wrap" class="hud-panel">
    <input id="search" type="text" placeholder="Search nodes..." spellcheck="false">
  </div>
</div>

<div id="legend" class="hud-panel">
  <div class="item"><span class="dot" style="color:#00FFFF"></span> L1 Focus</div>
  <div class="item"><span class="dot" style="color:#00FF88"></span> L2 Active</div>
  <div class="item"><span class="dot" style="color:#4169E1"></span> L3 Reference</div>
  <div class="item"><span class="dot" style="color:#8A2BE2"></span> L4 Archive</div>
  <div class="item"><span class="dot" style="color:#6C757D"></span> L5 Deep Archive</div>
  <div class="item"><span class="dot" style="color:#FFAA00"></span> L6 Web Knowledge</div>
</div>

<div id="status" class="hud-panel"><span id="node-count">0</span> nodes &middot; <span id="fps-counter">60</span> fps</div>

<div id="tooltip">
  <div class="tt-label" id="tt-label"></div>
  <div class="tt-meta" id="tt-meta"></div>
</div>

<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/"
  }
}
</script>
<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

// ===== CONSTANTS =====
const LVL_HEX = { 1: 0x00FFFF, 2: 0x00FF88, 3: 0x4169E1, 4: 0x8A2BE2, 5: 0x6C757D, 6: 0xFFAA00 };
const LVL_CSS = { 1: '#00FFFF', 2: '#00FF88', 3: '#4169E1', 4: '#8A2BE2', 5: '#6C757D', 6: '#FFAA00' };
const LEVEL_NAMES = { 1: 'Focus', 2: 'Active', 3: 'Reference', 4: 'Archive', 5: 'Deep Archive', 6: 'Web Knowledge' };
const EDGE_COL = {
  evolved_from:'#ff4444', supersedes:'#ff4444', evolves_from:'#ff4444',
  imports:'#00ff88', extends:'#00ff88', implements:'#00ff88',
  references:'#4488ff', related_to:'#4488ff', similar_to:'#4488ff', supports:'#4488ff',
  calls:'#ffdd00', depends_on:'#ffdd00', uses:'#ffdd00',
  belongs_to:'#ff6600', part_of:'#ff6600',
  default:'#334466'
};
const LVL_SIZE = { 1:22, 2:28, 3:36, 4:42, 5:52, 6:30 };
const SPREAD=600, REP=18000, ATT=0.003, ILEN=80, DAMP=0.82, STEPS=800, GCELL=120, MAX_E=8000;

function srand(s){const x=Math.sin(s*9301+49297)*49297;return x-Math.floor(x)}

// ===== DEMO DATA =====
const T = [
  // L5 Wisdom
  {l:'SOLID Principles',t:'pattern',lv:5},{l:'Separation of Concerns',t:'pattern',lv:5},
  {l:'Test-Driven Development',t:'pattern',lv:5},{l:'Event-Driven Architecture',t:'architecture',lv:5},
  {l:'Functional Composition',t:'pattern',lv:5},{l:'Clean Architecture',t:'architecture',lv:5},
  {l:'Immutable Data',t:'pattern',lv:5},
  // L4 Knowledge
  {l:'React Component Lifecycle',t:'code',lv:4},{l:'TypeScript Generics',t:'code',lv:4},
  {l:'SQL Query Optimization',t:'decision',lv:4},{l:'REST API Design',t:'pattern',lv:4},
  {l:'Git Branching Strategy',t:'decision',lv:4},{l:'Docker Containerization',t:'architecture',lv:4},
  {l:'WebSocket Protocol',t:'code',lv:4},{l:'CSS Grid Layout',t:'code',lv:4},
  {l:'Promise Patterns',t:'pattern',lv:4},{l:'State Machine Design',t:'architecture',lv:4},
  {l:'Middleware Pipeline',t:'pattern',lv:4},{l:'Error Boundaries',t:'pattern',lv:4},
  {l:'Database Indexing',t:'decision',lv:4},{l:'OAuth2 Flow',t:'pattern',lv:4},
  // L3 Context
  {l:'Auth Middleware Refactor',t:'code',lv:3},{l:'Payment Integration',t:'code',lv:3},
  {l:'Dashboard Redesign',t:'summary',lv:3},{l:'API Rate Limiting',t:'code',lv:3},
  {l:'DB Migration v3',t:'code',lv:3},{l:'Search Optimization',t:'code',lv:3},
  {l:'Caching Strategy',t:'decision',lv:3},{l:'WS Reconnection',t:'code',lv:3},
  {l:'Form Validation',t:'code',lv:3},{l:'Image Pipeline',t:'code',lv:3},
  {l:'Email Notifications',t:'code',lv:3},{l:'Role-Based Access',t:'code',lv:3},
  {l:'CI/CD Update',t:'summary',lv:3},{l:'Monitoring Setup',t:'code',lv:3},
  {l:'Performance Profiling',t:'summary',lv:3},{l:'Session Management',t:'code',lv:3},
  {l:'Logging Framework',t:'architecture',lv:3},{l:'Error Handling v2',t:'code',lv:3},
  // L2 Focus
  {l:'Fix Login Redirect',t:'error',lv:2},{l:'Update Dependencies',t:'code',lv:2},
  {l:'Dark Mode Toggle',t:'code',lv:2},{l:'Bundle Size Opt',t:'code',lv:2},
  {l:'Implement Pagination',t:'code',lv:2},{l:'Search Autocomplete',t:'code',lv:2},
  {l:'Fix Memory Leak',t:'error',lv:2},{l:'API Docs Update',t:'summary',lv:2},
  {l:'Export Feature',t:'code',lv:2},{l:'Refactor Settings',t:'code',lv:2},
  {l:'Add Tests for Auth',t:'code',lv:2},{l:'Optimize Queries',t:'code',lv:2},
  // L1 Instant
  {l:'Review PR #247',t:'code',lv:1},{l:'Debug Test Failure',t:'error',lv:1},
  {l:'Deployment Issue',t:'error',lv:1},{l:'Cleanup Imports',t:'code',lv:1},
  {l:'Quick CSS Fix',t:'code',lv:1},{l:'Check CI Status',t:'code',lv:1},
  {l:'Read Error Logs',t:'error',lv:1},{l:'Standup Notes',t:'summary',lv:1},
  {l:'Hotfix: Null Check',t:'error',lv:1},{l:'Merge Conflicts',t:'code',lv:1},
  // L6 Web
  {l:'React 19 Release',t:'pattern',lv:6},{l:'Next.js 15 Migration',t:'pattern',lv:6},
  {l:'Prisma v6 Changelog',t:'pattern',lv:6},{l:'TS 5.7 Features',t:'pattern',lv:6},
  {l:'Tailwind v4 Guide',t:'pattern',lv:6},{l:'Node.js 22 LTS',t:'pattern',lv:6},
  {l:'Bun Benchmarks',t:'pattern',lv:6},{l:'Deno 2.0',t:'pattern',lv:6},
];

const nodes = T.map((n,i)=>({id:'n'+i,label:n.l,type:n.t,level:n.lv,
  relevanceScore:Math.max(.1,1-(n.lv-1)*.15+srand(i*.37)*.2),
  accessCount:Math.floor(srand(i*.53)*50+1),
  content:n.l+' — '+n.t+' knowledge node at level '+n.lv,
  createdAt:'2025-01-15',lastAccessed:'2025-03-01'}));

// Generate edges
const E=[];
function addE(s,t,tp,w){if(s<nodes.length&&t<nodes.length)E.push({source:'n'+s,target:'n'+t,type:tp,weight:w})}
// L5 internal
addE(0,1,'similar_to',.8);addE(0,2,'similar_to',.7);addE(3,5,'similar_to',.9);addE(4,6,'similar_to',.6);addE(1,5,'similar_to',.7);
// L5→L4
addE(0,7,'evolved_from',.9);addE(0,10,'evolved_from',.7);addE(2,7,'evolved_from',.8);
addE(3,14,'evolved_from',.8);addE(3,16,'evolved_from',.7);addE(5,12,'evolved_from',.8);
addE(4,15,'evolved_from',.6);addE(1,17,'evolved_from',.7);addE(6,8,'evolved_from',.5);
// L4 internal
addE(7,17,'similar_to',.6);addE(8,15,'similar_to',.5);addE(10,9,'calls',.7);
addE(13,16,'depends_on',.8);addE(11,12,'related_to',.5);addE(14,19,'depends_on',.7);addE(18,9,'calls',.8);
// L4→L3
addE(7,21,'evolved_from',.8);addE(10,23,'evolved_from',.7);addE(9,24,'calls',.6);
addE(13,27,'evolved_from',.7);addE(17,30,'evolved_from',.6);addE(19,31,'evolved_from',.8);
addE(15,28,'calls',.5);addE(16,35,'evolved_from',.7);addE(18,25,'calls',.6);addE(14,36,'calls',.5);
addE(12,22,'related_to',.4);addE(8,37,'calls',.5);
// L3 internal
addE(21,31,'depends_on',.8);addE(22,28,'calls',.6);addE(23,26,'depends_on',.7);
addE(25,27,'depends_on',.5);addE(29,30,'calls',.6);addE(33,34,'similar_to',.5);
addE(24,25,'depends_on',.7);addE(32,33,'related_to',.4);addE(26,36,'calls',.5);addE(35,37,'depends_on',.6);
// L3→L2
addE(21,38,'evolved_from',.7);addE(28,42,'evolved_from',.6);addE(25,43,'evolved_from',.5);
addE(22,40,'calls',.6);addE(23,41,'depends_on',.5);addE(29,44,'evolved_from',.7);
addE(37,46,'evolved_from',.6);addE(26,47,'calls',.5);addE(31,48,'depends_on',.6);addE(24,49,'calls',.4);
// L2 internal
addE(38,46,'related_to',.5);addE(40,41,'similar_to',.4);addE(42,43,'depends_on',.6);
addE(44,45,'calls',.5);addE(47,49,'related_to',.3);
// L2→L1
addE(38,50,'evolved_from',.6);addE(46,51,'calls',.5);addE(40,54,'calls',.4);
addE(42,56,'evolved_from',.5);addE(49,57,'calls',.4);addE(44,52,'depends_on',.5);addE(41,59,'calls',.4);
// L1 internal
addE(50,51,'related_to',.4);addE(52,53,'depends_on',.5);addE(54,55,'similar_to',.3);addE(56,57,'calls',.4);
// L6→various
addE(60,7,'imports',.7);addE(61,21,'imports',.6);addE(62,24,'imports',.5);addE(63,8,'imports',.6);
addE(64,14,'imports',.5);addE(65,13,'imports',.4);addE(66,41,'imports',.5);addE(67,12,'imports',.4);
addE(60,61,'similar_to',.4);addE(63,64,'similar_to',.3);addE(65,66,'similar_to',.3);

const edges = E;
const projectName = 'HelixMind';

// ===== RENDERER (max perf: no AA, pixelRatio 1) =====
const R = new THREE.WebGLRenderer({antialias:false,alpha:true,powerPreference:'high-performance'});
R.setSize(innerWidth,innerHeight);
R.setPixelRatio(1);
document.body.prepend(R.domElement);

const scene = new THREE.Scene();
scene.background = new THREE.Color('#050510');
scene.fog = new THREE.FogExp2('#050510',0.00005);

const cam = new THREE.PerspectiveCamera(55,innerWidth/innerHeight,1,12000);
cam.position.set(0,200,1200);

const ctrl = new OrbitControls(cam,R.domElement);
ctrl.target.set(0,0,0);
ctrl.enableDamping=true;ctrl.dampingFactor=0.06;
ctrl.autoRotate=true;ctrl.autoRotateSpeed=0.08;
ctrl.minDistance=80;ctrl.maxDistance=4000;
ctrl.maxPolarAngle=Math.PI*0.85;ctrl.minPolarAngle=Math.PI*0.15;
ctrl.update();

// ===== STARS (static) =====
const stP=new Float32Array(700*3);
for(let i=0;i<700;i++){stP[i*3]=(srand(i*31)-.5)*5000;stP[i*3+1]=(srand(i*37)-.5)*5000;stP[i*3+2]=(srand(i*41)-.5)*5000;}
const stG=new THREE.BufferGeometry();
stG.setAttribute('position',new THREE.BufferAttribute(stP,3));
scene.add(new THREE.Points(stG,new THREE.PointsMaterial({size:1.2,color:'#223344',transparent:true,opacity:.5,blending:THREE.AdditiveBlending,depthWrite:false,sizeAttenuation:true})));

// ===== STATIC SHADERS (zero per-frame cost) =====
const nMat = new THREE.ShaderMaterial({
  vertexShader:`
    attribute float aSize;
    attribute vec3 aColor;
    attribute float aHL;
    varying vec3 vC;
    varying float vA;
    void main(){
      vC=aColor; vA=aHL;
      vec4 mv=modelViewMatrix*vec4(position,1.0);
      gl_PointSize=aSize*aHL*(500.0/-mv.z);
      gl_Position=projectionMatrix*mv;
    }`,
  fragmentShader:`
    varying vec3 vC;
    varying float vA;
    void main(){
      vec2 c=gl_PointCoord-vec2(.5);
      float d=length(c);
      if(d>.5)discard;
      float i=exp(-d*d*60.0)+exp(-d*d*10.0)*.6+exp(-d*d*3.0)*.3+exp(-d*d*0.8)*.15;
      float core=exp(-d*d*60.0);
      gl_FragColor=vec4(vC*(1.0+core*1.2),i*vA);
    }`,
  transparent:true,depthWrite:false,blending:THREE.AdditiveBlending
});

const eMat = new THREE.ShaderMaterial({
  vertexShader:`
    attribute vec3 color;
    attribute float aA;
    varying vec3 vC;
    varying float vA;
    void main(){ vC=color; vA=aA; gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0); }`,
  fragmentShader:`
    varying vec3 vC;
    varying float vA;
    void main(){ gl_FragColor=vec4(vC,vA); }`,
  transparent:true,depthWrite:false,blending:THREE.AdditiveBlending
});

// ===== SCENE STATE =====
const nC=nodes.length;
const byLvl={};
nodes.forEach((n,i)=>{if(!byLvl[n.level])byLvl[n.level]=[];byLvl[n.level].push(i)});
const tc=new THREE.Color();

// ===== FORCE-DIRECTED LAYOUT =====
const P=new Float64Array(nC*3), V=new Float64Array(nC*3);
for(let i=0;i<nC;i++){
  const phi=Math.acos(2*srand(i*13)-1), th=srand(i*17)*Math.PI*2, r=SPREAD*Math.cbrt(srand(i*23));
  P[i*3]=r*Math.sin(phi)*Math.cos(th); P[i*3+1]=r*Math.sin(phi)*Math.sin(th); P[i*3+2]=r*Math.cos(phi);
}

// Adjacency
const nMap={};nodes.forEach((n,i)=>{nMap[n.id]=i});
const adj={}, nEdgeMap={};
const ePairs=[];
edges.forEach((e,ei)=>{
  const si=nMap[e.source], ti=nMap[e.target];
  if(si===undefined||ti===undefined) return;
  if(!adj[si])adj[si]=new Set(); if(!adj[ti])adj[ti]=new Set();
  adj[si].add(ti); adj[ti].add(si);
  if(!nEdgeMap[si])nEdgeMap[si]=[]; if(!nEdgeMap[ti])nEdgeMap[ti]=[];
  nEdgeMap[si].push(ei); nEdgeMap[ti].push(ei);
  ePairs.push([si,ti]);
});

// Force simulation (one-time, blocking)
for(let step=0;step<STEPS;step++){
  const grid={};
  for(let i=0;i<nC;i++){
    const k=Math.floor(P[i*3]/GCELL)+','+Math.floor(P[i*3+1]/GCELL)+','+Math.floor(P[i*3+2]/GCELL);
    if(!grid[k])grid[k]=[]; grid[k].push(i);
  }
  for(let i=0;i<nC;i++){
    const gx=Math.floor(P[i*3]/GCELL), gy=Math.floor(P[i*3+1]/GCELL), gz=Math.floor(P[i*3+2]/GCELL);
    for(let dx=-1;dx<=1;dx++) for(let dy=-1;dy<=1;dy++) for(let dz=-1;dz<=1;dz++){
      const c=grid[(gx+dx)+','+(gy+dy)+','+(gz+dz)];
      if(!c) continue;
      for(const j of c){
        if(j<=i) continue;
        const ddx=P[i*3]-P[j*3], ddy=P[i*3+1]-P[j*3+1], ddz=P[i*3+2]-P[j*3+2];
        const dSq=ddx*ddx+ddy*ddy+ddz*ddz+1, d=Math.sqrt(dSq), f=REP/dSq;
        const fx=ddx*f/d, fy=ddy*f/d, fz=ddz*f/d;
        V[i*3]+=fx; V[i*3+1]+=fy; V[i*3+2]+=fz;
        V[j*3]-=fx; V[j*3+1]-=fy; V[j*3+2]-=fz;
      }
    }
  }
  for(const[si,ti]of ePairs){
    const ddx=P[ti*3]-P[si*3], ddy=P[ti*3+1]-P[si*3+1], ddz=P[ti*3+2]-P[si*3+2];
    const d=Math.sqrt(ddx*ddx+ddy*ddy+ddz*ddz)+0.1, f=(d-ILEN)*ATT;
    const fx=ddx/d*f, fy=ddy/d*f, fz=ddz/d*f;
    V[si*3]+=fx; V[si*3+1]+=fy; V[si*3+2]+=fz;
    V[ti*3]-=fx; V[ti*3+1]-=fy; V[ti*3+2]-=fz;
  }
  for(let i=0;i<nC*3;i++){ P[i]+=V[i]; V[i]*=DAMP; }
}

const pos=new Array(nC);
for(let i=0;i<nC;i++) pos[i]=new THREE.Vector3(P[i*3],P[i*3+1],P[i*3+2]);

// ===== NODES (fully static geometry) =====
const nGeo=new THREE.BufferGeometry();
const nP=new Float32Array(nC*3), nCol=new Float32Array(nC*3), nSz=new Float32Array(nC), nHL=new Float32Array(nC);
for(let i=0;i<nC;i++){
  const p=pos[i], n=nodes[i];
  nP[i*3]=p.x; nP[i*3+1]=p.y; nP[i*3+2]=p.z;
  tc.set(LVL_HEX[n.level]||0x00FFFF);
  nCol[i*3]=tc.r; nCol[i*3+1]=tc.g; nCol[i*3+2]=tc.b;
  nSz[i]=LVL_SIZE[n.level]||36;
  nHL[i]=1.0;
}
nGeo.setAttribute('position',new THREE.BufferAttribute(nP,3));
nGeo.setAttribute('aColor',new THREE.BufferAttribute(nCol,3));
nGeo.setAttribute('aSize',new THREE.BufferAttribute(nSz,1));
nGeo.setAttribute('aHL',new THREE.BufferAttribute(nHL,1));
const nPts=new THREE.Points(nGeo,nMat);
scene.add(nPts);

// ===== EDGES (fully static geometry, typed colors) =====
const allE=[];
edges.forEach((e,i)=>{
  const si=nMap[e.source], ti=nMap[e.target];
  if(si!==undefined&&ti!==undefined) allE.push({si,ti,w:e.weight,t:e.type,i});
});
allE.sort((a,b)=>b.w-a.w);
const vEdges=allE.slice(0,MAX_E);
const eC=vEdges.length;

const eP=new Float32Array(eC*6), eCol=new Float32Array(eC*6), eA=new Float32Array(eC*2);
const ec=new THREE.Color(), aS=Math.min(1.0,3000/eC);
for(let i=0;i<eC;i++){
  const{si,ti,w,t}=vEdges[i];
  const s=pos[si], d=pos[ti], o=i*6;
  eP[o]=s.x; eP[o+1]=s.y; eP[o+2]=s.z;
  eP[o+3]=d.x; eP[o+4]=d.y; eP[o+5]=d.z;
  ec.set(EDGE_COL[t]||EDGE_COL.default);
  eCol[o]=ec.r; eCol[o+1]=ec.g; eCol[o+2]=ec.b;
  eCol[o+3]=ec.r; eCol[o+4]=ec.g; eCol[o+5]=ec.b;
  const ba=0.06+w*0.14;
  eA[i*2]=ba*aS; eA[i*2+1]=ba*aS;
}
const eGeo=new THREE.BufferGeometry();
eGeo.setAttribute('position',new THREE.BufferAttribute(eP,3));
eGeo.setAttribute('color',new THREE.BufferAttribute(eCol,3));
eGeo.setAttribute('aA',new THREE.BufferAttribute(eA,1));
const eLines=new THREE.LineSegments(eGeo,eMat);
scene.add(eLines);

// ===== HUD =====
document.getElementById('node-count').textContent=nC;
document.getElementById('stats').textContent=projectName+' \u00b7 '+nC+' nodes \u00b7 '+edges.length+' connections';
for(let lv=1;lv<=6;lv++){const el=document.getElementById('lc'+lv);if(el)el.textContent=(byLvl[lv]||[]).length;}

// ===== INTERACTION =====
const ray=new THREE.Raycaster();
ray.params.Points={threshold:12};
const mouse=new THREE.Vector2();
let hovIdx=-1, selIdx=-1, camTw=null, lvlToggles={};

const ttEl=document.getElementById('tooltip');
const ttL=document.getElementById('tt-label'), ttM=document.getElementById('tt-meta');
const detail=document.getElementById('detail');
const detailLabel=document.getElementById('detail-label');
const detailMeta=document.getElementById('detail-meta');
const detailConn=document.getElementById('detail-conn');

document.querySelectorAll('[data-level]').forEach(b=>{
  lvlToggles[parseInt(b.dataset.level)]=b.classList.contains('active');
  updateBtnStyle(b);
});

R.domElement.addEventListener('mousemove',(e)=>{
  mouse.x=(e.clientX/innerWidth)*2-1;
  mouse.y=-(e.clientY/innerHeight)*2+1;
  ray.setFromCamera(mouse,cam);
  const hits=ray.intersectObject(nPts);
  const prev=hovIdx;
  if(hits.length>0){
    hovIdx=hits[0].index;
    R.domElement.style.cursor='pointer';
    const n=nodes[hovIdx];
    ttL.textContent=n.label;
    ttM.innerHTML='Level '+n.level+' &middot; '+LEVEL_NAMES[n.level]+'<br>'+n.type+' &middot; Score: '+n.relevanceScore.toFixed(2);
    ttEl.style.display='block';
    ttEl.style.left=(e.clientX+14)+'px';
    ttEl.style.top=(e.clientY-10)+'px';
  } else {
    hovIdx=-1; R.domElement.style.cursor='default'; ttEl.style.display='none';
  }
  if(prev!==hovIdx) updateHL();
});

R.domElement.addEventListener('click',()=>{
  if(hovIdx>=0){
    if(selIdx===hovIdx){
      selIdx=-1; detail.classList.remove('visible');
      ctrl.autoRotate=true;
      camTw={sP:cam.position.clone(),sL:ctrl.target.clone(),tP:new THREE.Vector3(0,200,1200),tL:new THREE.Vector3(0,0,0),p:0};
    } else {
      selIdx=hovIdx;
      showDetail(selIdx);
      ctrl.autoRotate=false;
      const np=pos[selIdx], dir=cam.position.clone().sub(np).normalize();
      camTw={sP:cam.position.clone(),sL:ctrl.target.clone(),tP:np.clone().add(dir.multiplyScalar(70)),tL:np.clone(),p:0};
    }
    updateHL();
  } else if(selIdx>=0){
    selIdx=-1; detail.classList.remove('visible');
    ctrl.autoRotate=true;
    camTw={sP:cam.position.clone(),sL:ctrl.target.clone(),tP:new THREE.Vector3(0,200,1200),tL:new THREE.Vector3(0,0,0),p:0};
    updateHL();
  }
});

document.getElementById('detail-close').addEventListener('click',()=>{
  selIdx=-1; detail.classList.remove('visible');
  ctrl.autoRotate=true; updateHL();
});

function showDetail(idx){
  const n=nodes[idx];
  detailLabel.textContent=n.label;
  const lvCol=LVL_CSS[n.level];
  detailMeta.innerHTML='<span><span style="color:'+lvCol+'">&bull;</span> Level '+n.level+' &middot; '+LEVEL_NAMES[n.level]+'</span>'
    +'<span>'+n.type+'</span>'
    +'<span>Score: '+n.relevanceScore.toFixed(2)+'</span>'
    +'<span>Accessed: '+n.accessCount+'x</span>';
  const connCount=adj[idx]?adj[idx].size:0;
  detailConn.textContent=connCount+' connection'+(connCount!==1?'s':'');
  detail.classList.add('visible');
}

// ===== HIGHLIGHTS (only on interaction, zero per-frame cost) =====
function updateHL(){
  const ha=nGeo.attributes.aHL;
  const ea=eGeo.attributes.aA;
  const sq=document.getElementById('search').value.toLowerCase();
  const hasS=sq.length>0, hasF=selIdx>=0;
  const cHov=hovIdx>=0&&adj[hovIdx]?adj[hovIdx]:new Set();
  const cSel=selIdx>=0&&adj[selIdx]?adj[selIdx]:new Set();

  for(let i=0;i<nC;i++){
    let h=1.0;
    const lv=nodes[i].level;
    if(lvlToggles[lv]===false){ ha.array[i]=0.05; continue; }
    if(hasS){ h=nodes[i].label.toLowerCase().includes(sq)?1.0:0.12; }
    if(hasF){ h=cSel.has(i)||i===selIdx?1.0:0.1; }
    if(hovIdx>=0){ if(i===hovIdx)h=Math.max(h,1.5); else if(cHov.has(i))h=Math.max(h,1.2); }
    ha.array[i]=h;
  }
  ha.needsUpdate=true;

  const aET=getActiveET();
  const alphaS=Math.min(1.0,3000/eC);
  for(let i=0;i<eC;i++){
    const{si,ti,w,t}=vEdges[i];
    const sLv=nodes[si].level, tLv=nodes[ti].level;
    if(lvlToggles[sLv]===false||lvlToggles[tLv]===false){ ea.array[i*2]=0; ea.array[i*2+1]=0; continue; }
    let a=(0.06+w*0.14)*alphaS;
    if(aET!==null&&!aET.has(t)) a=0;
    if(hasF){ a=(si===selIdx||ti===selIdx)?0.4+w*0.3:0.01; }
    if(hovIdx>=0){ if(si===hovIdx||ti===hovIdx) a=Math.max(a,0.35+w*0.3); }
    if(hasS){ if(!nodes[si].label.toLowerCase().includes(sq)&&!nodes[ti].label.toLowerCase().includes(sq)) a=0.01; }
    ea.array[i*2]=a; ea.array[i*2+1]=a;
  }
  ea.needsUpdate=true;
}

function getActiveET(){
  const all=document.querySelector('[data-edge="all"]');
  if(all&&all.classList.contains('active'))return null;
  const s=new Set();
  document.querySelectorAll('[data-edge].active').forEach(b=>{ if(b.dataset.edge!=='all')s.add(b.dataset.edge); });
  return s.size>0?s:null;
}

// ===== SEARCH =====
document.getElementById('search').addEventListener('input',()=>updateHL());

// ===== LEVEL TOGGLES =====
function updateBtnStyle(b){
  const a=b.classList.contains('active'), c=b.dataset.color||'#00d4ff';
  if(a){ b.style.borderColor=c+'80'; b.style.color=c; b.style.background=c+'18'; b.style.textShadow='0 0 8px '+c+'60'; }
  else{ b.style.borderColor='rgba(255,255,255,0.06)'; b.style.color='#334'; b.style.background='rgba(255,255,255,0.02)'; b.style.textShadow='none'; }
}
document.querySelectorAll('[data-level]').forEach(b=>{
  updateBtnStyle(b);
  b.addEventListener('click',()=>{ b.classList.toggle('active'); lvlToggles[parseInt(b.dataset.level)]=b.classList.contains('active'); updateBtnStyle(b); updateHL(); });
});

// ===== EDGE TOGGLES =====
document.querySelectorAll('[data-edge]').forEach(b=>{
  b.addEventListener('click',()=>{
    if(b.dataset.edge==='all'){
      document.querySelectorAll('[data-edge]').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
    } else {
      document.querySelector('[data-edge="all"]').classList.remove('active');
      b.classList.toggle('active');
      if(!document.querySelectorAll('[data-edge].active').length) document.querySelector('[data-edge="all"]').classList.add('active');
    }
    updateHL();
  });
});

// ===== KEYBOARD =====
document.addEventListener('keydown',(e)=>{
  if(e.key==='Escape'&&selIdx>=0){
    selIdx=-1; detail.classList.remove('visible');
    ctrl.autoRotate=true; updateHL();
    camTw={sP:cam.position.clone(),sL:ctrl.target.clone(),tP:new THREE.Vector3(0,200,1200),tL:new THREE.Vector3(0,0,0),p:0};
  }
  if(e.key==='/'&&document.activeElement!==document.getElementById('search')){
    e.preventDefault(); document.getElementById('search').focus();
  }
});

// ===== ANIMATE (ultra-minimal: only controls + render + tween) =====
let fpsF=0, lastFT=performance.now();
const clock=new THREE.Clock();

function animate(){
  requestAnimationFrame(animate);
  const dt=clock.getDelta();

  if(camTw){
    camTw.p=Math.min(camTw.p+dt*1.8,1);
    const e=1-Math.pow(1-camTw.p,3);
    cam.position.lerpVectors(camTw.sP,camTw.tP,e);
    ctrl.target.lerpVectors(camTw.sL,camTw.tL,e);
    if(camTw.p>=1)camTw=null;
  }

  ctrl.update();
  R.render(scene,cam);

  fpsF++;
  const now=performance.now();
  if(now-lastFT>1000){ document.getElementById('fps-counter').textContent=fpsF; fpsF=0; lastFT=now; }
}

// ===== RESIZE =====
addEventListener('resize',()=>{ cam.aspect=innerWidth/innerHeight; cam.updateProjectionMatrix(); R.setSize(innerWidth,innerHeight); });

// ===== START =====
animate();

</script>
</body>
</html>
